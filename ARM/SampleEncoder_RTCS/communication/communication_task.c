/*****************************************************************************
 * University of Southern Denmark
 * Embedded C Programming (ECP)
 *
 * MODULENAME.: communication_task.c
 *
 * PROJECT....: G3 - Tracking system utilizing a pan/tilt system
 *
 * DESCRIPTION: See module specification file (.h-file).
 *
 * Change Log:
 ******************************************************************************
 * Date    Id    Change
 * YYMMDD
 * --------------------
 * 1404XX  G3    Communication task added.
 * 1405XX  G3    Communication task modified.
 *
 *****************************************************************************/

/***************************** Include files *******************************/
#include "communication/communication_task.h"
#include "RTCS/rtcs.h"
#include "inc\lm3s6965.h"
#include "debug/debug.h"

/*****************************    Defines    *******************************/
#define TICK_INTERUPT_MS 500

#define NORMAL 0
#define FIXEDROTATION 1

// decide runmode
#define RUNMODE NORMAL

// for fixedrotation
#define ROTATIONS 20 // 0 = infinity
#define STARTVALUE 0x80000000
#define TICKSPERROTATION 360
#define FIXEDSPEED 298
#define DIRECTION 1 // 1 and 0

// for normal
#define REPEAT_PWM 1000 //* ½ ms (500µs)
/*
 *  100 = 50ms
 * 1000 = 500ms
 * 2000 = 1s
 */



extern INT32U encoderTicks;



/*****************************   Constants   *******************************/
/*****************************   Variables   *******************************/
INT8U array[1000] = {30,62,92,93,97,39,54,66,27,61,80,13,73,24,29,90,65,59,55,71,56,65,18,64,79,38,98,0,14,56,73,78,12,77,16,40,64,44,23,96,93,54,17,19,37,51,2,54,74,64,15,69,81,98,90,70,88,22,97,23,98,11,69,75,71,86,20,96,86,100,97,40,72,1,29,78,94,4,95,42,54,82,11,33,5,4,43,85,75,41,88,100,56,67,24,54,39,3,40,61,98,83,72,81,85,29,20,10,65,89,49,67,58,90,33,19,76,12,86,71,45,34,80,23,77,78,57,42,100,39,77,28,96,20,38,87,38,55,42,86,55,88,55,16,55,20,6,61,99,38,15,87,76,19,68,53,35,89,30,36,34,28,65,54,16,3,31,12,81,79,53,59,18,18,27,100,73,73,8,92,50,91,30,87,94,57,88,3,92,51,87,99,9,28,46,32,40,1,24,72,85,63,28,71,18,55,76,42,62,42,48,53,0,14,88,79,65,48,36,19,22,78,71,70,70,64,57,46,66,58,67,24,91,14,11,8,78,76,72,7,59,38,0,36,14,52,37,78,89,83,2,11,70,59,96,30,9,91,10,65,93,33,31,52,73,13,1,3,63,40,99,93,76,2,19,96,5,0,8,45,95,33,34,49,42,97,49,52,70,11,82,6,78,70,99,17,74,66,91,8,5,51,60,51,73,19,28,24,33,93,26,48,51,41,53,72,40,73,1,95,98,27,10,62,71,58,81,10,60,59,75,78,22,56,8,41,72,63,17,84,13,74,67,77,53,87,93,59,79,4,100,100,36,92,19,29,64,83,22,95,78,18,9,88,24,7,27,27,94,48,21,96,45,81,14,66,99,66,93,46,41,76,13,10,58,44,100,99,12,96,47,64,34,20,98,8,2,100,16,39,24,56,53,4,45,72,78,67,73,34,30,35,8,3,81,25,8,77,13,95,46,27,15,94,84,20,94,21,71,2,97,39,87,65,44,28,44,91,94,83,59,89,20,73,42,15,69,66,29,6,94,32,68,54,39,64,66,34,69,21,6,39,19,70,92,83,98,67,15,58,8,8,85,10,29,75,26,42,98,37,92,80,30,55,84,43,36,14,32,82,46,12,100,3,92,70,69,34,53,56,34,63,86,15,31,9,50,37,29,9,0,22,29,42,98,42,79,28,69,33,24,20,20,24,15,55,70,91,25,16,85,92,43,60,79,72,96,14,34,2,73,44,10,80,61,45,98,11,65,40,66,86,8,18,21,81,51,27,74,92,63,13,78,86,71,87,1,3,32,18,60,39,67,89,98,71,84,75,13,77,45,42,50,95,33,92,53,33,21,37,46,100,24,81,41,19,24,20,36,43,30,14,100,53,72,65,31,92,83,57,37,51,74,10,54,11,100,90,33,93,98,58,97,54,59,16,99,9,99,69,28,10,11,55,92,41,79,62,25,83,61,52,26,25,83,69,91,27,7,48,32,67,31,36,58,74,47,86,31,8,88,66,68,46,4,88,63,83,61,15,15,15,88,80,6,19,58,77,67,95,67,42,29,7,94,74,40,52,11,11,17,9,70,13,17,0,59,41,33,99,16,93,53,55,76,0,95,25,77,84,58,21,49,6,80,16,84,32,37,27,99,21,29,68,11,95,88,85,83,37,5,81,86,53,52,76,62,32,84,28,32,88,56,60,75,91,6,42,4,89,96,54,65,3,93,22,55,91,1,12,60,38,21,44,81,87,30,73,49,31,90,78,26,100,37,83,72,55,81,33,34,19,80,28,53,9,20,100,70,48,34,77,25,34,62,35,35,55,53,97,71,67,16,74,74,31,75,11,35,94,77,82,49,68,86,22,60,92,68,75,75,8,12,31,82,89,32,24,13,38,24,91,22,80,66,39,69,6,100,38,45,6,80,81,63,63,30,30,41,94,19,6,13,5,4,32,31,97,19,94,100,68,31,51,93,70,48,96,60,92,90,8,60,42,74,83,92,14,21,61,83,35,34,23,91,72,85,76,65,41,80,70,5,15,22,2,57,54,28,51,28,48,26,82,18,3,15,67,54,2,73,95,12,26,61,44,43,80,81,20,6,31,54,50,42,29,44,2,31,95,90,34,16,22,58,65,86,57,31,12,56,5,18,63,93,57,33,32,93,16,74,30,95,88,91,74,65,85,42,13,68,80,17,2,74,40,10,51,6,76,77,6,9,26,96,60,92,6,43,70,56,1,13,61,60,65,64,88,25,12,71,34,3,55,12,29,95,62,13,87};

INT8U duration[1000] =
                {0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0,
                1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0,
                1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1,
                1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0,
                0, 0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1,
                1, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1,
                0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0,
                1, 1, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1,
                0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1,
                1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1,
                0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1,
                0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1,
                0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0,
                1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0,
                1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 1,
                0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0,
                0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1,
                1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0,
                0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1,
                0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0,
                1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1,
                1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0,
                0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1,
                0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0,
                0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1,
                1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1,
                0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1,
                1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1,
                1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0,
                1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0,
                0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 1,
                1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1,
                1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1,
                1, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1,
                0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1,
                0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1,
                1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1,
                0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0,
                1, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0};
/*****************************   Functions   *******************************/
void init_communication_task(){
  // init pwm
  SYSCTL_RCGC0_R |= SYSCTL_RCGC0_PWM; // Enable the PWM clock

  SYSCTL_RCGC2_R |= SYSCTL_RCGC2_GPIOB; // Enable the clock to PORTB

  GPIO_PORTB_AFSEL_R |= 0x3; // Enable the PB0 alternate function
  GPIO_PORTB_DEN_R |= 0x3;

  SYSCTL_RCC_R |= SYSCTL_RCC_USEPWMDIV; //Enable PWM divide
  SYSCTL_RCC_R &= ~SYSCTL_RCC_PWMDIV_M;
  SYSCTL_RCC_R |= SYSCTL_RCC_PWMDIV_8;

  //Magic!
  PWM_1_CTL_R &= ~PWM_X_CTL_ENABLE;
  PWM_1_GENA_R |= 0x8C;
  PWM_1_GENB_R |= 0x80C;

  PWM_INVERT_R |= 0x0C;

  PWM_1_LOAD_R = 299;

  PWM_1_CMPA_R = 0;
  PWM_1_CMPB_R = 0;

  PWM_1_CTL_R |= PWM_X_CTL_ENABLE; // Start the timers

  PWM_ENABLE_R |= (PWM_ENABLE_PWM3EN | PWM_ENABLE_PWM2EN);
  //UARTprintf("Starting Communication Task\r\n");

  _start(COMMUNICATION_TASK, MILLI_SEC(0));
}
void communication_task()
/*****************************************************************************
 *   Input    : 	-
 *   Output   : 	-
 *   Function :
 *   Run @	 :
 *****************************************************************************/
{
  debug_pin_red(OFF);
  static INT16S i = 0;
  static INT16S n = 0;
  static INT16S j = 0;

  // send ticks and pwm
  UARTCharPut(0, encoderTicks >> 24);
  UARTCharPut(0, encoderTicks >> 16);
  UARTCharPut(0, encoderTicks >> 8);
  UARTCharPut(0, encoderTicks);
  UARTCharPut(0, array[n]);

#if RUNMODE == NORMAL
  if (i == 0)
    {
    debug_pin_red(TOGGLE);
    // update n
    if(duration[(j-1)%1000] != duration[j])
      {
      // inc n
      ++n;
      n %= 1000;
      }

    // set pwm
    if(array[n]>50)
      {
      PWM_1_CMPB_R = 0;
      PWM_1_CMPA_R = (array[n] - 50)*2.98;
      }
    else
      {
      PWM_1_CMPA_R = 0;
      PWM_1_CMPB_R = (50 - array[n])*2.98;
      }

    // inc j (bit array)
    ++j;
    j %= 1000;
  }

  ++i;
  i %= REPEAT_PWM;
#endif



#if RUNMODE == FIXEDROTATION
  if (ROTATIONS == 0) {
#if DIRECTION == 0
    PWM_1_CMPB_R = 0;
    PWM_1_CMPA_R = FIXEDSPEED;
#endif
#if DIRECTION == 1
    PWM_1_CMPB_R = FIXEDSPEED;
    PWM_1_CMPA_R = 0;
#endif

  }
  else {
    if (encoderTicks >= (STARTVALUE + ROTATIONS*TICKSPERROTATION)) {
      PWM_1_CMPA_R = 0;
      PWM_1_CMPB_R = 0;
    }
    else {
#if DIRECTION == 0
    PWM_1_CMPB_R = 0;
    PWM_1_CMPA_R = FIXEDSPEED;
#endif
#if DIRECTION == 1
    PWM_1_CMPB_R = FIXEDSPEED;
    PWM_1_CMPA_R = 0;
#endif
    }
  }

#endif
}

/****************************** End Of Module *******************************/
